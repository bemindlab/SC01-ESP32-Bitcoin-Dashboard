#!/bin/bash
# Git pre-commit hook for Bitcoin Dashboard
# Runs before each commit to ensure code quality

set -e

echo "üîç Running pre-commit checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if there are any staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED_FILES" ]; then
    echo "${YELLOW}‚ö†Ô∏è  No staged files to check${NC}"
    exit 0
fi

echo "üìù Staged files:"
echo "$STAGED_FILES"
echo ""

# Function to check for common issues
check_code_quality() {
    echo "üîç Checking code quality..."

    # Check for debug prints (Serial.print/println that might be forgotten)
    DEBUG_PRINTS=$(git diff --cached | grep -i "^\+.*Serial\.print" | grep -v "\/\/" || true)
    if [ ! -z "$DEBUG_PRINTS" ]; then
        echo "${YELLOW}‚ö†Ô∏è  Warning: Found Serial.print statements in staged changes${NC}"
        echo "${YELLOW}   Consider removing debug prints before committing:${NC}"
        echo "$DEBUG_PRINTS"
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    # Check for TODO/FIXME comments in new code
    TODO_COMMENTS=$(git diff --cached | grep -i "^\+.*\/\/.*\(TODO\|FIXME\|HACK\|XXX\)" || true)
    if [ ! -z "$TODO_COMMENTS" ]; then
        echo "${YELLOW}‚ö†Ô∏è  Info: Found TODO/FIXME comments in staged changes${NC}"
        echo "$TODO_COMMENTS"
        echo ""
    fi

    # Check for sensitive data (API keys, passwords)
    SENSITIVE_PATTERNS="(api[_-]?key|password|secret|token|credentials).*=.*['\"][^'\"]{10,}"
    SENSITIVE_DATA=$(git diff --cached | grep -iE "^\+.*$SENSITIVE_PATTERNS" | grep -v "template" | grep -v "example" || true)
    if [ ! -z "$SENSITIVE_DATA" ]; then
        echo "${RED}‚ùå ERROR: Potential sensitive data found in staged changes!${NC}"
        echo "${RED}   Never commit API keys, passwords, or secrets!${NC}"
        echo "$SENSITIVE_DATA"
        echo ""
        exit 1
    fi

    echo "${GREEN}‚úì Code quality checks passed${NC}"
    echo ""
}

# Function to check file sizes
check_file_sizes() {
    echo "üìä Checking file sizes..."

    LARGE_FILES=$(git diff --cached --name-only | xargs -I {} du -h {} 2>/dev/null | awk '$1 ~ /M$/ {print}' || true)
    if [ ! -z "$LARGE_FILES" ]; then
        echo "${YELLOW}‚ö†Ô∏è  Warning: Large files detected:${NC}"
        echo "$LARGE_FILES"
        echo ""
        read -p "Continue with large files? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        echo "${GREEN}‚úì File size checks passed${NC}"
    fi
    echo ""
}

# Function to check for common C++ issues
check_cpp_syntax() {
    echo "üîß Checking C++ code..."

    CPP_FILES=$(echo "$STAGED_FILES" | grep -E '\.(cpp|h)$' || true)
    if [ -z "$CPP_FILES" ]; then
        echo "${GREEN}‚úì No C++ files to check${NC}"
        echo ""
        return 0
    fi

    # Check for missing semicolons in class definitions
    for file in $CPP_FILES; do
        if [ -f "$file" ]; then
            # Check for class definitions without semicolon
            MISSING_SEMI=$(grep -n "^}[[:space:]]*$" "$file" | head -5 || true)
            if [ ! -z "$MISSING_SEMI" ]; then
                echo "${YELLOW}‚ö†Ô∏è  Check: Ensure class/struct definitions end with semicolon in $file${NC}"
            fi
        fi
    done

    echo "${GREEN}‚úì C++ syntax checks passed${NC}"
    echo ""
}

# Main execution
check_code_quality
check_file_sizes
check_cpp_syntax

echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo ""
exit 0
